name: CI/CD Pipeline

on:
   push:
      branches: [main, master, develop]
   pull_request:
      branches: [main, master, develop]

jobs:
   # Job 1: Quality checks
   quality:
      name: Code Quality
      runs-on: ubuntu-latest

      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: '20'
              cache: 'npm'

         - name: Install dependencies
           run: npm ci

         - name: Run type check
           run: npm run type-check

         - name: Run Prettier check
           run: npm run format:check

         - name: Run ESLint
           run: npm run lint

   # Job 2: Build
   build:
      name: Build Project
      runs-on: ubuntu-latest
      needs: quality

      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: '20'
              cache: 'npm'

         - name: Install dependencies
           run: npm ci

         - name: Build project
           run: npm run build

         - name: Upload build artifacts
           uses: actions/upload-artifact@v4
           with:
              name: build-output
              path: dist/
              retention-days: 7

   # Job 3: Deploy (chỉ chạy khi push vào main/master)
   deploy:
      name: Deploy to Production
      runs-on: ubuntu-latest
      needs: build
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Download build artifacts
           uses: actions/download-artifact@v4
           with:
              name: build-output
              path: dist/

         - name: Deploy to Netlify
           uses: nwtgck/actions-netlify@v3.0
           with:
              publish-dir: './dist'
              production-branch: main
              github-token: ${{ secrets.GITHUB_TOKEN }}
              deploy-message: 'Deploy from GitHub Actions'
              enable-pull-request-comment: true
              enable-commit-comment: true
           env:
              NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
              NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
           timeout-minutes: 5
